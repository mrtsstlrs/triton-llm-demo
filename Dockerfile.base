# syntax=docker/dockerfile:1.6
FROM ubuntu:24.04

ARG DEBIAN_FRONTEND=noninteractive

# Версии, соответствующие стеку релиза 25.12 (см. NVIDIA release notes)
# CUDA:   13.1.x
# cuBLAS: 13.2.0.9
# cuDNN:  9.17.1.4 (в apt репозитории без суффикса +cuda13.0)
# TRT:    10.14.1 (в репозитории пакеты обычно 10.14.1.48-1+cuda13.0)
ARG CUBLAS_VER="13.2.0.9-1"
ARG CUDNN_VER="9.17.1.4-1"
ARG TRT_VER="10.14.1.48-1+cuda13.0"

# Базовые зависимости для сборки (и чтобы build.py работал)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg2 lsb-release \
    build-essential git git-lfs \
    cmake ninja-build pkg-config \
    python3 python3-dev python3-pip python3-venv \
    patchelf \
    && rm -rf /var/lib/apt/lists/*

# Подключаем NVIDIA CUDA apt repo (без NGC образов)
# Для Ubuntu 24.04:
RUN curl -fsSL \
      https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb \
      -o /tmp/cuda-keyring.deb \
 && dpkg -i /tmp/cuda-keyring.deb \
 && rm -f /tmp/cuda-keyring.deb

# Устанавливаем CUDA Toolkit 13.1 + cuBLAS/cuDNN/TensorRT (dev + runtime)
# Замечание: версии пакетов могут иметь точные суффиксы в репозитории; при необходимости подправьте ARG-и выше.
RUN apt-get update && apt-get install -y --no-install-recommends \
    cuda-toolkit-13-1 \
    cuda-cudart-dev-13-1 \
    libcublas-13-1=${CUBLAS_VER} \
    libcublas-dev-13-1=${CUBLAS_VER} \
    libcudnn9-cuda-13=${CUDNN_VER} \
    libcudnn9-dev-cuda-13=${CUDNN_VER} \
    libnvinfer10=${TRT_VER} \
    libnvinfer-dev=${TRT_VER} \
    libnvinfer-plugin10=${TRT_VER} \
    libnvinfer-plugin-dev=${TRT_VER} \
    libnvonnxparsers10=${TRT_VER} \
    libnvonnxparsers-dev=${TRT_VER} \
    && rm -rf /var/lib/apt/lists/*

# Удобные переменные окружения (часто полезны при сборке)
ENV CUDA_HOME=/usr/local/cuda
ENV PATH="${CUDA_HOME}/bin:${PATH}"
ENV LD_LIBRARY_PATH="${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}"

# Python deps, которые часто нужны сборочным скриптам Triton (в т.ч. distro)
# Используем venv, чтобы не нарушать PEP 668 в Ubuntu 24.04.
RUN python3 -m venv /opt/venv \
 && /opt/venv/bin/python -m pip install --no-cache-dir -U pip setuptools wheel \
 && /opt/venv/bin/python -m pip install --no-cache-dir \
    distro packaging requests pyyaml
ENV PATH="/opt/venv/bin:${PATH}"

WORKDIR /workspace
